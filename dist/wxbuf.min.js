/*!
 * wxbuf.js v1.0.0
 * (c) 2024 lingluo
 * the MIT License.
 */
const t=function(t){return Object.prototype.toString.call(t)==="[object Object]"};const n=function(t){return Object.prototype.toString.call(t)==="[object Number]"};const e=function(t){return Object.prototype.toString.call(t)==="[object Function]"};const o=function(t){return Object.prototype.toString.call(t)==="[object String]"};const r=function(t,n){return t.hasOwnProperty(n)};const s=function(t){return Array.isArray(t)};const c=function(n){if(t(n)){return!Object.keys(n).length}if(s(n)){return!n.length}if(o(n)){return n.trim()}if(n===null||n===undefined){return true}return false};const a=function(t,...n){return Object.assign(t,...n)};const i=function(t,n){t=t.split("");t[n]=t[n].toUpperCase();return t.join("")};const l=function(t,n=""){return n+t.split("?")[0].replace(/^\/+/,"")};const u=function(){};const f=function(n){return n&&t(n)&&n.target&&n.timeStamp&&n.currentTarget&&n.type};const p=function(t){let n,e;n=e=t.selectOwnerComponent();if(e===null){return t}while(n=e.selectOwnerComponent()){e=n}return e};const h=function(n){if(!t(n)){return""}const e=[];for(let o in n){if(n.hasOwnProperty(o)){let r=n[o];if(t(r)||s(r)){r=JSON.stringify(r)}e.push(`${o}=${r}`)}}return e.join("&")};const g=function(t=""){const n={};const e=t.split("&");if(e.length){e.forEach((t=>{const[e,o]=t.split("=");n[e]=o}))}return n};const w=function(n,e){e=t(e)?h(e):e;return e?[n,e].join(n.includes("?")?"":"?"):n};const d=function(e,o=false){if(!t(e)||o){return e}for(let o in e){const c=e[o];if(r(e,o)&&c){try{const r=JSON.parse(c);if(t(r)||s(r)||r===null){e[o]=r}else if(n(r)&&c===r.toString()){e[o]=r}}catch(t){}if(c==="undefined"){e[o]=undefined}}}return e};const m=function(){if(__wxConfig&&__wxConfig.tabBar&&__wxConfig.tabBar.list){return __wxConfig.tabBar.list.map((t=>t.pagePath.replace(/\.html$/,"")))}return[]};const x=function(t){return m().includes(l(t))};const S=function(){if(page&&__wxConfig&&__wxConfig.page&&__wxConfig.page[page.route+".html"]){return __wxConfig.page[page.route+".html"].window.navigationBarTitleText}return""};const b=function(t){return __wxAppCode__?__wxAppCode__[t.replace(/^\//,"")+".json"]||{}:{}};const y=t=>{if(/->/.test(t)){const[n,e]=t.split("->").map((t=>o(t)?t.trim():t));t=e?e:n;return[n,t]}return[t,t]};const $=function(t,n,e){if(!r(t,n)){Object.defineProperty(t,n,{get:()=>e})}};const P=[];const v=[];function D(t){P.push(t)}function _(t){const n=P.indexOf(t);const e=P[n]||null;if(n>-1){P.splice(n,1)}return e}function O(t){v.push(t)}function k(t){const n=v.findIndex((n=>n.context===t));const e=v.find((n=>n.context===t));if(n>-1){v.splice(n,1)}return e}const T=function(t,n){const e=n.split("?")[1];n=n.split("?")[0];const o=n.startsWith("/")?[]:t.split("/");const r=n.split("/");let s=null;o.pop();while(r.length){s=r.shift();if(s===".."){o.pop()}else if(s===""||s==="."){continue}else if(s.indexOf(".")===-1){o.push(s)}else{throw new Error(`path'${n}' is invalid`)}}return o.join("/").replace(/^\/*/,"/")+(e?`?${e}`:"")};var j={resolve:T};class E{constructor(){this.watchers=[]}add(n){if(t(n)&&!c(n)){this.watchers.push(n)}}invoke(t,n,...e){for(let o=0,r=this.watchers.length;o<r;o++){const r=this.watchers[o];if(r.hasOwnProperty(t)){r[t].call(n,...e)}}}}const A=["data","onLoad","onShow","onReady","onHide","onUnload","onPullDownRefresh","onReachBottom","onShareAppMessage","onShareTimeline","onPageScroll","onTabItemTap","onResize","onAddToFavorites"];const C=wx.getStorageSync;const G=function(){const t={};return{get(n){if(!t.hasOwnProperty(n)){t[n]=C.call(wx,n)}return t[n]===undefined?"":t[n]},set(n,e){t[n]=e},remove(n){delete t[n]}}}();const B={storage:"mixinStorage",globalData:"mixinGlobalData"};const U={storage:"onStorageChange",globalData:"onGlobalDataChange"};let L=null;let R=[];let I=null;const M=function(t,n){if(n.mixinGlobalData||n.mixinStorage){const e={};R.forEach((({kvs:t,name:o})=>{const s=n[B[o]]||[];s.forEach((n=>{const[o,s]=y(n);if(r(t,o)){e[s]=t[o]}}))}));if(!c(e)){t.setData(e)}}R.forEach((({kvs:o,oldkvs:r,name:s})=>{const c=n[U[s]];if(e(c)){c.apply(t,[o,r])}}))};function N(t,n){if(!I){I=n}J();H(t);Q()}function H(t){const n=R.findIndex((n=>n.name===t.name));if(n>-1){const{kvs:e,oldkvs:o,name:r}=R[n];t={kvs:a(e,t.kvs),oldkvs:a(o,t.oldkvs),name:r};R.splice(n,1)}R.push(t)}function J(){if(L){clearTimeout(L);L=null}}function Q(){L=setTimeout((function(){P.forEach((t=>M(t,t)));v.forEach((({context:t,option:n})=>M(t,n)));R.forEach((({kvs:t,oldkvs:n,name:e})=>{const o=`on${i(e,0)}Change`;I(o,t,n)}));R=[]}),0)}const W=new E;let F={methodPrefix:"",parseUrlArgs:false,enableGlobalSharePage:false};let z={};const q={page:{},component:{}};const K=App;const V=Page;const X=Component;const Y=Behavior;const Z=wx;const tt=wx.setStorage;const nt=wx.batchSetStorage;const et=wx.batchSetStorageSync;const ot=wx.removeStorage;wx.getStorageSync;const rt=wx.setStorageSync;const st=wx.removeStorageSync;const ct=wx.clearStorage;const at=wx.clearStorageSync;const it=wx.navigateTo;const lt=wx.redirectTo;const ut=wx.reLaunch;const ft=wx.switchTab;wx=Object.assign(Object.create(Z.__proto__),wx);const pt={extend(t){q.page=a(q.page,t)}};const ht={extend(t){q.component=a(q.component,t)}};const gt=function(t,n){const o=q[n];for(let n in o){const r=o[n];if(e(r)){t[n]=r}}};const wt=function(t,n,...e){W.invoke(n,t,...e)};const dt=function(t){if(e(z[t])){return z[t].apply(getApp(),[].slice.call(arguments,1))}};const mt=function(t,n=true){for(let o in t){if(t.hasOwnProperty(o)&&(!n||!A.includes(o))&&e(t[o])){const n=t[o];t[o]=function(t){if(f(t)&&!t._ignore){wt(this,"on"+i(t.type,0),a(t,{path:p(this).route}))}if(n){if(z.onUIEventDispatch&&f(t)&&!t._ignore){let e=true;let o=[t];const r=function(){e=false;o=[].slice.call(arguments,0)};z.onUIEventDispatch.call(getApp(),t,r);$(t,"_ignore",true);if(!e){return n.apply(this,o)}}else{if(f(t)){$(t,"_ignore",true)}return n.apply(this,arguments)}}}}}};const xt=function(t){if(!/^\//.test(t.url)){throw new URIError(`url必须以/开头`)}return dt("beforePageEnter",t,b(l(t.url)))??true};const St=function(t,n=false){const e=w(t.url,t.params);if(n){lt.call(wx,{url:e})}else{it.call(wx,{url:e})}};const bt=function(t){const n=__wxAppCode__||{};let e;const o=/\.json$/i;for(let s in n){e=n[s];if(r(n,s)&&o.test(s)&&e.name===t){return`/${s.replace(o,"")}`}}return null};const yt=function(t){if(t.name&&!t.url){const n=bt(t.name);if(!n){throw new Error(`[wxbuf]: 不存在name为'${t.name}'的页面`)}t.url=n}};const $t=function(t){yt(t);if(xt(t)){Kt(t,this);const n=Yt(t);fn(t);St(t);return n}return Promise.reject()};const Pt=function(t){yt(t);if(xt(t)){fn(t);St(t,true)}};const vt=function(t,n){if(n.$feature){n.$feature.resolve(t);n.$feature=null}return wx.navigateBack()};const Dt=function(t,n){const e=Jt();const o=j.resolve(e?e.route:"/",n.url);if(dt("beforePageEnter",Object.assign({},n,{url:o}),b(o))===false){return Promise.reject()}if(t===ft){gn(n);n.url=n.url.split("?")[0]}return t.call(wx,n)};const _t=function(t){return Dt(it,t)};const Ot=function(t){return Dt(lt,t)};const kt=function(t){return Dt(ut,t)};const Tt=function(t){hn=null;return Dt(ft,t)};const jt=function(n,o){const r={route:this.$route,value:o};const s=function(o,s){if(t(s)&&e(s[n])){s[n].call(o,r)}};P.forEach((t=>s(t,t.listeners)));v.forEach((({context:t,option:n})=>s(t,n.listeners)));s(getApp(),z.listeners)};const Et=function(t,n,e){const o=`mixin${i(e,0)}`;const s=function(n,e=[]){e.forEach((e=>{const[o,s]=y(e);if(r(t,o)){n.data[s]=t[o]}}))};P.forEach((t=>s(t,t[o])));v.forEach((({context:t,option:n})=>s(t,n[o])));N({kvs:t,oldkvs:n,name:e},dt)};const At=function(t){const{success:n,key:e,data:o}=t;if(!e)return;const r=G.get(e);t.success=function(){G.set(e,o);Et({[e]:o},{[e]:r},"storage");return(n||u).apply(this,arguments)};return tt.apply(wx,arguments)};const Ct=function(t){const{kvList:n,success:e}=t;const o=function(){const t={};n.forEach((({key:n})=>t[n]=Bt(n)));return t}();t.success=function(){const t={};n.forEach((({key:n,value:e})=>{t[n]=e;G.set(n,e)}));Et(t,o,"storage");return(e||u).apply(this,arguments)};return nt.apply(wx,arguments)};const Gt=function(t){const{key:n,success:e}=t;if(!n)return;const o=G.get(n);t.success=function(){G.remove(n);Et({[n]:""},{[n]:o});return(e||u).apply(this,arguments)};return ot.call(wx,t)};const Bt=function(t){return G.get(t)};const Ut=function(t,n){if(!t)return;const e=G.get(t);G.set(t,n);rt.call(wx,t,n);Et({[t]:n},{[t]:e},"storage")};const Lt=function(t){const n={};const e={};t.forEach((({key:t,value:o})=>{n[t]=o;G.set(t,o);e[t]=Bt(t)}));Et(n,e,"storage");return et.apply(wx,arguments)};const Rt=function(t){if(!t)return;const n=G.get(t);G.remove(t);st.call(wx,t);Et({[t]:""},{[t]:n},"storage")};const It=function(t={}){const n=t.success;const e=Z.getStorageInfoSync().keys;t.success=function(){const t={};const o={};e.forEach((n=>{t[n]="";G.remove(n);o[n]=Bt(n)}));Et(t,o,"storage");return(n||u).apply(wx,arguments)};return ct.call(wx,t)};const Mt=function(){const t={};const n={};Z.getStorageInfoSync().keys.forEach((e=>{t[e]="";G.remove(e);n[e]=Bt(e)}));Et(t,n,"storage");return at.apply(wx,arguments)};const Nt=function(t){const n=getApplication();return n.globalData?t?n.globalData[t]:n.globalData:undefined};const Ht=function(t,n){const e=getApplication();if(!e.globalData){e.globalData={}}const o=e.globalData[t];e.globalData[t]=n;Et({[t]:n},{[t]:o},"globalData")};const Jt=function(){const t=getCurrentPages();return t.length?t[t.length-1]:null};const Qt=function(t,n){const{globalData:e}=getApp();["GlobalData","Storage"].forEach((o=>{const r=t[`mixin${o}`];if(s(r)){const t={};r.forEach((n=>{const[r,s]=y(n);t[s]=o==="GlobalData"?e[r]:Bt(r)}));n.setData(t)}}))};const Wt=function(t,n,e){const o=t[n];t[n]=function(){e.apply(this,arguments);if(o){return o.apply(this,arguments)}}};const Ft=function(t){const{methodPrefix:n}=F;t[`${n}openPage`]=$t;t[`${n}replacePage`]=Pt;t[`${n}getGlobalData`]=Nt;t[`${n}setGlobalData`]=Ht;t[`${n}getStorageSync`]=Bt;t[`${n}setStorageSync`]=Ut;t[`${n}removeStorageSync`]=Rt;t[`${n}setStorage`]=At;t[`${n}removeStorage`]=Gt;t[`${n}batchSetStorage`]=Ct;t[`${n}batchSetStorageSync`]=Lt;t[`${n}clearStorage`]=It;t[`${n}clearStorageSync`]=Mt;t[`${n}fireEvent`]=jt};const zt=function(t){const n=t.getPageId();return new Proxy({},{get(t,o){const r=getCurrentPages().find((t=>t.getPageId()===n));if(r){return e(r[o])?r[o].bind(r):r[o]}else{console.warn("wxbuf: 访问了不存在的页面实例");return undefined}}})};let qt=null;const Kt=function(t,n){qt={success:t.success,url:l(t.url),page:n===wx||n===getApp()?Jt():p(n)}};const Vt=function(t){if(qt&&qt.url===t.route){t.$opener=qt.page;if(e(qt.success)){qt.success.call(qt.page,zt(t))}qt=null}else{t.$opener=null}};let Xt=null;const Yt=function(t){return new Promise(((n,e)=>{Xt={resolve:n,url:l(t.url)}}))};const Zt=function(t){if(Xt&&t.route===Xt.url){t.$feature=Xt;Xt=null}const n=t.onUnload||u;t.onUnload=function(){if(t.$feature){t.$feature.resolve();t.$feature=null}return n.apply(t,arguments)}};const tn=function(t){t.$setData=t.setData};const nn=function(t,n){const o=t.observers||{};if(c(o))return;const r=n.setData;n.setData=function(t){const s=a({},n.data);r.apply(n,arguments);for(let r in t){const c=o[r];if(t.hasOwnProperty(r)&&e(c)){if(t[r]!==s[r]){c.call(n,t[r],s[r])}}}}};const en=function(t,n){const o=t.computed||{};if(c(o))return;const r=n.$setData;n.setData=function(){r.apply(n,arguments);const t={};for(let r in o){const s=o[r];if(e(s)){t[r]=s.call(n)}}if(!c(t)){r.call(n,t)}}};const on=function(t){if(F.enableGlobalSharePage&&!t.onShareAppMessage){t.onShareAppMessage=function(){return{title:S(),url:[this.route,this.$rawParamsQuery].join("?")}}}};const rn=function(t,n){return new Proxy(t,{get(t,n){return t[n]},set(t,e,o){const r=t[e];if(r!==o){n&&n({[e]:o},{[e]:r},"globalData")}t[e]=o;return true}})};let sn=null;const cn=function(t){sn=t};Object.defineProperty(globalThis,"getApplication",{value:function(){return getApp()||sn},configurable:false,writable:false,enumerable:false});Object.defineProperty(globalThis,"getSavedPages",{value:function(){return P.slice(0)},configurable:false,writable:false,enumerable:false});App=function(t={}){z=t;if(t.globalData){t.globalData=rn(t.globalData,Et)}const n=function(...t){cn(this);wt(this,"onAppLaunch",...t)};const e=function(){wt(this,"onAppHide")};const o=function(){wt(this,"onAppShow")};Wt(t,"onLaunch",n);Wt(t,"onHide",e);Wt(t,"onShow",o);Ft(t);return K(t)};const an=function(t,n,e){if(t._ignore){return}const o=t[n]||u;t[n]=function(){if(e.apply(this,arguments)===false){return}return o.apply(this,arguments)};t._ignore=true};const ln=function(t){const n=function(n){const e=j.resolve(t.is,n.url);return dt("beforePageEnter",Object.assign({},n,{url:e}),b(l(e)))};an(t.pageRouter,"navigateTo",n);an(t.pageRouter,"redirectTo",n);an(t.pageRouter,"reLaunch",n);an(t.pageRouter,"switchTab",n);an(t.router,"navigateTo",n);an(t.router,"redirectTo",n);an(t.router,"reLaunch",n);an(t.router,"switchTab",n)};let un=null;const fn=function(t){un={data:t.body,url:l(t.url)}};const pn=function(t,n){if(un&&un.data&&un.url===n.route){a(t,un.data);un=null}};let hn=null;const gn=function(t){const n=t.url.split("?")[1];if(n){hn={url:l(t.url),data:g(n)}}};const wn=function(t,n){if(hn&&x(n.route)&&hn.url===n.route){a(t,hn.data);hn=null}};const dn=function(t){return function(n){D(this);tn(this);Vt(this);pn(n,this);wn(n,this);ln(this);Zt(this);en(t,this);Qt(t,this);nn(t,this);this.$rawParamsQuery=h(n);this.$rawParams=a({},n);this.$route=this.route;d(n,!F.parseUrlArgs);this.$params=n;wt(this,"onPageLoad",{option:n,path:this.route});dt("onPageLoad",{option:n,path:this.route})}};const mn=function(t){const n=t.onShow||u;t.onShow=function(){let t=null;if(hn&&x(this.route)&&hn.url===this.route&&this._wakeUp){const n={};wn(n,this);a(this.$params,n);this.$rawParamsQuery=h(this.$params);this.$rawParams=a({},this.$params);d(n,!F.parseUrlArgs);d(this.$params,!F.parseUrlArgs);t=n}wt(this,"onPageShow",{option:this.$params,path:this.route});dt("onPageChange",this);const e=n.call(this);if(this._wakeUp&&this.onWakeup){this.onWakeup(t||{})}$(this,"_wakeUp",true);return e}};const xn=function(t,n){return function(e){wt(this,n,a({path:this.route},e||{}));v.forEach((({context:n,page:e,option:o})=>{if(e===this&&o.pageLifetimes&&o.pageLifetimes[t]){o.pageLifetimes[t].apply(n,arguments)}}))}};Page=function(t){mt(t);on(t);Wt(t,"onLoad",dn(t));mn(t);Wt(t,"onUnload",(function(){_(this)}));Wt(t,"onPullDownRefresh",xn("pullDownRefresh","onPagePullDownRefresh"));Wt(t,"onReachBottom",xn("reachBottom","onPageReachBottom"));Wt(t,"onPageScroll",xn("pageScroll","onPageScroll"));t[`${F.methodPrefix}finish`]=function(t){vt(t,this)};Ft(t);gt(t,"page");return V(t)};const Sn=function(t,n){const{pageMethods:o}=t;if(o){const t=p(n);for(let r in o){const s=o[r];if(o.hasOwnProperty(r)&&e(s)&&!t[r]){t[r]=s.bind(n);t[r].$installedBy=n}}}};const bn=function(t,n){const{pageMethods:e}=t;if(e){const t=p(n);for(let o in e){if(t[o]&&t[o].$installedBy===n){delete t[o]}}}};const yn=function(){return p(this).$params};const $n=function(t,n){t=t||{};t.methods=t.methods||{};t.lifetimes=t.lifetimes||{};const e=t.lifetimes.created||t.created;const o=t.lifetimes.attached||t.attached;const r=t.lifetimes.detached||t.detached;const s=function(){try{tn(this);en(t,this);Qt(t,this);ln(this)}catch(t){}if(e){return e.apply(this,arguments)}};const c=function(){const e=n===X;const r=p(this);O({context:this,option:t,type:e?"component":"behavior",page:r});this.$route=r.route;this.$feature=r.$feature;this.$page=r;Qt(t,this);if(e){Sn(t,this);const n=this.selectOwnerComponent();if(!n.$components){n.$components=[]}n.$components.push(this);this.$parent=n}if(o){return o.apply(this,arguments)}};const a=function(){const t=k(this);if(t.type==="component"){bn(t.option,this);const n=this.selectOwnerComponent();if(n.$components){const t=n.$components.indexOf(this);if(t>-1){n.$components.splice(t,1);this.$parent=null}}}if(r){return r.apply(this,arguments)}};t.lifetimes.created=s;t.lifetimes.attached=c;t.lifetimes.detached=a;mt(t.methods,false);t.methods[`${F.methodPrefix}finish`]=function(t){vt(t,this.$page)};t.methods[`${F.methodPrefix}getUrlParams`]=yn;t.methods[`${F.methodPrefix}getPageInstance`]=function(){return p(this)};Ft(t.methods);if(n===X){gt(t.methods,"component")}return n(t)};Component=function(t){return $n(t,X)};Behavior=function(t){return $n(t,Y)};function Pn(t={}){W.add(t)}function vn(t={}){a(F,t);On()}const Dn={extend(t,n){if(t==="wx"){console.warn("global.extend: 不能重复定义wx")}else{Object.defineProperty(globalThis,t,{get:()=>n})}}};const _n={openPage:wx.openPage,replacePage:wx.replacePage,getGlobalData:wx.getGlobalData,setGlobbalData:wx.setGlobalData,finish:wx.finish};function On(){a(wx,_n);const{methodPrefix:t}=F;wx[`${t}openPage`]=$t;wx[`${t}replacePage`]=Pt;wx[`${t}getGlobalData`]=Nt;wx[`${t}setGlobalData`]=Ht;wx[`${t}finish`]=function(t){vt(t,Jt())};wx.getStorageSync=Bt;wx.setStorage=At;wx.setStorageSync=Ut;wx.removeStorageSync=Rt;wx.removeStorage=Gt;wx.batchSetStorage=Ct;wx.batchSetStorageSync=Lt;wx.clearStorage=It;wx.clearStorageSync=Mt;wx.navigateTo=_t;wx.redirectTo=Ot;wx.reLaunch=kt;wx.switchTab=Tt}On();const kn=Pn;const Tn=vn;const jn=pt;const En=ht;const An=Dn;const Cn={page:jn,watch:kn,config:Tn,global:An,component:En,setStorage:At,removeStorage:Gt,getStorageSync:Bt,setStorageSync:Ut,removeStorageSync:Rt,clearStorage:It,clearStorageSync:Mt,batchSetStorage:Ct,batchSetStorageSync:Lt,setGlobalData:Ht,getGlobalData:Nt,reLaunch:kt,navigateTo:_t,redirectTo:Ot,switchTab:Tt,getNavigateBarTitle:S,getTabBarPages:m,isTabBarPage:x,getConfigJson:b};An.extend("wxbuf",Cn);Object.defineProperty(Cn,"version",{get:()=>"1.0",configurable:false});export{En as component,Tn as config,Cn as default,An as global,jn as page,kn as watch};
